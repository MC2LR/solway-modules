<!DOCTYPE html>
<html lang="en" data-ng-app="app">

<head>
    <meta charset="utf-8" />
    <title>新能云集中监控系统</title>
    <meta name="description" content="基于大数据云平台，实现能源设备海量数据的采集、存储、监控和分析。建立多个数据分析模型，提高资产运营效益和质量。" />
    <meta name="keyword" content="新能云集中监控系统,新能源,光伏,风电,电站监控,远程监视">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="cache-control" content="no-cache">
    <meta http-equiv="expires" content="0">
    <!-- <link type="image/x-icon" rel="shortcut icon" href="loginPageImg/favicon.ico"> -->
    <!-- <script type="text/javascript" src="https://s96.cnzz.com/z_stat.php?id=1277657171&web_id=1277657171"></script> -->
    <script src="./jquery/jquery.min.js" type="text/javascript"></script>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        body>a {
            display: none;
        }

        .clearfix:before,
        .clearfix:after {
            content: "";
            display: table;
            clear: both;
        }

        .clearfix {
            *zoom: 1;
        }

        .login .login-input {
            width: 100%;
            height: 40px;
            background: rgba(248, 248, 248, 1);
            border-radius: 4px;
            border: none;
            text-indent: 1em;
        }

        input:-webkit-autofill {
            -o-box-shadow: 0 0 0px 1000px rgba(248, 248, 248, 1) inset !important;
            -ms-box-shadow: 0 0 0px 1000px rgba(248, 248, 248, 1) inset !important;
            -moz-box-shadow: 0 0 0px 1000px rgba(248, 248, 248, 1) inset !important;
            -webkit-box-shadow: 0 0 0px 1000px rgba(248, 248, 248, 1) inset !important;
            box-shadow: 0 0 0px 1000px rgba(248, 248, 248, 1) inset !important;
        }

        .login .phone-code {
            margin-bottom: 18px;
            background: rgba(248, 248, 248, 1);
            position: relative;
            display: none;
        }

        .login .smallCompanyName {
            font-size: 18px;
        }

        .login .bigCompanyName {
            margin-top: 10px;
            font-size: 18px;
        }

        .text-center {
            text-align: center;
        }
    </style>
    <script>
        if (window._czc) {
            window._czc.push(["_setAutoPageview", false]);
            window._czc.push(["_setCustomVar", "访客级别", "游客", "-1"]);
        }
        window.reqBeforStr = location.host.split(':')[1] ? '' : '';
    </script>
</head>

<body class="login"
    style="background: url('./loginPageImg/login-bg-new.png') no-repeat;background-size: cover;color:rgba(69,69,69,1);">
    <div class="logo-con clearfix"
        style="width:790px;height:518px;margin:0 auto;position: absolute;top: 50%;margin-top: -262px;left: 50%;margin-left: -395px;box-shadow: 0px 14px 38px rgba(5,35,65,0.8);">
        <div
            style="width:395px;height:525px;float:left;background:url('./loginPageImg/company-bg.png') no-repeat;background-size: cover">
        </div>
        <div style="width:395px;height:525px;float:left;background:rgba(255,255,255,1);border-radius: 0 12px 12px 0;">
            <div class="text-center" style="margin:35px 0 0px;height: 140px;">
                <div style="height:50px;"><img src="" id="logo-img" style="max-height:100%;"></div>
                <div style="font-size:24px;height: 50px;line-height: 50px;" id="company-name"></div>
                <div class="smallCompanyName" id="system-name"></div>
            </div>
            <div style="padding:0px 36px;">
                <div style="margin-bottom:18px;"><input type="text" placeholder="用户名" class="login-input"
                        id="login_username"></div>
                <div style="margin-bottom:18px;"><input type="password" placeholder="密码" class="login-input"
                        id="login_pass"></div>
                <!-- <div style="margin-bottom:18px;" class="clearfix">
                    <div style="float:left;width:45%;">
                        <input oninput="this.value.length === 4 ? login() : null;" type="text" placeholder="随机验证码"
                            class="login-input" id="login_code">
                    </div>
                    <div style="float:left;width:55%;padding-left: 20px;box-sizing: border-box;">
                        <img class="validate-x1" id="validateCode" title="点击更换" onclick="javascript:aRefresh();"
                            src="Login/randomValidateCode.htm"
                            style="border: 1px solid rgb(0,0,0,0.2);height: 37px;width: 98px;">
                        <a onclick="javascript:aRefresh();" class="validate-x2" href="javascript:void(0);"
                            style="vertical-align: text-bottom;color: #363f44;text-decoration: none;">换一张</a>
                    </div>
                </div> -->
                <!-- <div class="clearfix phone-code">
                    <div style="width:70%;"><input type="text" placeholder="手机验证码" class="login-input" id="phoneCode">
                    </div>
                    <a style="color:rgb(6,190,189);position: absolute;right: 20px;top: 12px;"
                        class="getPhoneCode">获取验证码</a>
                </div> -->

                <p id="loginMessage"
                    style="font-size: 14px; font-family: '黑体'; color: red; text-align: center; margin-bottom: -10px; display: none;">
                </p>
                <div id="submit" onclick="login()"
                    style="height:40px;line-height: 40px;margin-top: 25px;background:rgba(31,141,225,1);border-radius:4px;text-align: center;color:white;font-size:20px;cursor: pointer;">
                    登录
                </div>
                <div class="clearfix" style="color:rgba(69,69,69,0.8);margin-top:10px;">
                    <div style="float:left;cursor: pointer;" onclick="forgetPwd()">忘记密码？</div>
                    <div style="float:right;cursor: pointer;" onclick="goRegistPage()">注册新用户</div>
                </div>
            </div>
        </div>
    </div>
    <script>
        $(function () {
            function getLocalIPs(callback) {
                var ips = [];
                var RTCPeerConnection = window.RTCPeerConnection || window.webkitRTCPeerConnection || window.mozRTCPeerConnection;

                var pc = new RTCPeerConnection({ iceServers: [] });
                pc.createDataChannel('');

                pc.onicecandidate = function (e) {
                    if (!e.candidate) {
                        pc.close();
                        callback(ips);
                        return;
                    }
                    var ip = /^candidate:.+ (\S+) \d+ typ/.exec(e.candidate.candidate)[1];
                    if (ips.indexOf(ip) == -1) ips.push(ip);
                };
                pc.createOffer(function (sdp) {
                    pc.setLocalDescription(sdp);
                }, function onerror() { });
            }

            getLocalIPs(function (ips) {
                $.ajaxSetup({
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader("CIP:'" + ips.join() + "'");
                    },
                });
            });

        });
    </script>

    <script>

        function setCookie(name, value) {
            var exp = new Date();
            exp.setTime(exp.getTime() + 30 * 60 * 1000);
            document.cookie = name + "=" + escape(value) + ";expires=" + exp.toGMTString();
        }

        function getCookie(name) {
            var value, arrCookie = document.cookie.split(";");
            for (var i = 0; i < arrCookie.length; i++) {
                var arr = arrCookie[i].split("=");
                if (arr[0].trim() == name) {
                    value = arr[1];
                    break;
                }
            }
            return value;
        }

        function delCookie(name) {
            var exp = new Date();
            exp.setTime(exp.getTime() - 1);
            var cval = getCookie(name);
            if (cval != null) {
                document.cookie = name + "=" + cval + ";expires=" + exp.toGMTString();
            }
        }

    </script>

    <script>
        // if(localStorage.getItem("remoteLogin")){
        //     $('.phone-code').show();
        // }
        var cookieRemoteFlag = getCookie('remoteLogin');
        if (cookieRemoteFlag == '1') {
            $('.phone-code').show();
        }
        var cookiePhone = getCookie('phone');
        $("#login_username").blur(function () {
            if (cookiePhone == $("#login_username").val()) {
                $('.phone-code').show();
            } else {
                $('.phone-code').hide();
                phoneCodeFlag = false;
                $("#loginMessage").html("");
                $("#loginMessage").hide();
            }
        });

        var platformAgent = navigator.userAgent;
        if (/(iPhone|iPad|iPod|iOS|android)/i.test(platformAgent)) {
            window.location = "http://necloud.solway.cn/necloud-m";
        }
        if (!navigator.cookieEnabled) {
            alert("当前浏览器禁止使用Cookie，请开启Cookie否则您将无法正常浏览本网站！谢谢合作！！！");
        }

        function aRefresh() {
            if (disabledGetRandomCode) return;
            $("#validateCode").attr("src", reqBeforStr + "/Login/randomValidateCode.htm?" + Math.random());
        }
        aRefresh();

        // var phoneVeg = /^((\+?86)|(\(\+86\)))?(13[0123456789][0-9]{8}|15[012356789][0-9]{8}|18[012356789][0-9]{8}|147[0-9]{8}|1349[0-9]{7})$/;
        // var phoneVeg = /^[1][3,4,5,6,7,8,9][0-9]{9}$/;
        var phoneVeg = /^[1][0-9]{10}$/;

        var disabledGetRandomCode = false;

        var timer;
        var num = 0;
        var phoneCodeFlag = false;
        //获取手机验证码
        $('body').on('click', '.getPhoneCode', function () {

            var $this = $(this);

            $("#loginMessage").html("");

            var phoneNumber = $("#login_username").val();
            if (!phoneVeg.test(phoneNumber)) {
                $("#loginMessage").html("请输入合法的手机号");
                $("#loginMessage").show();
                return false;
            }

            var verifyCode = $("#login_code").val();
            if (!verifyCode) {
                $("#loginMessage").html("请输入随机验证码");
                $("#loginMessage").show();
                $('#login_code').val('').focus();
                return false;
            }

            $.post(reqBeforStr + '/Login/sendVerifyCode.htm', {
                phone: phoneNumber,
                countryCode: 86,
                busitype: '04',
                randomCode: verifyCode
            }, function (data, textStatus, xhr) {
                if (data.code == 0) {
                    num = 60;
                    disabledGetRandomCode = true;
                    $this.html(num + '秒后重新获取').css("color", 'grey')
                    $this.prop('disabled', true);
                    function countdownInter() {
                        if (num > 1) {
                            num = num - 1;
                            $this.html(num + '秒后重新获取').css("color", 'grey');
                        } else {
                            $this.prop('disabled', false);
                            $this.html('重新获取验证码').css("color", 'rgb(6,190,189)');
                            clearInterval(timer)
                        }

                    }
                    timer = setInterval(countdownInter, 1000);
                } else if (data.code == 1) {
                    $("#loginMessage").html(data.msg);
                    $("#loginMessage").show();
                    aRefresh();
                    $('#login_code').val('').focus();
                }

            });
        });

        function login() {
            if ($('#submit').html() === '登录中...') return;

            $("#loginMessage").html("");

            var username = $("#login_username").val();
            var password = $("#login_pass").val();
            // var code = $("#login_code").val();

            if (username == "" || null == username || null == password
                || password == "") {
                $("#loginMessage").html("用户名和密码不能为空");
                $("#loginMessage").show();
                return false;
            }

            $('#submit').html('登录中...');

            $.post("/microplat/oauth/token ", {
                username: username,
                password: password,
                grant_type: 'password',
                client_id: 'necloud_web',
                client_secret: 'necloud618',
                tenant: 'tenant001'
            }, function (msg) {
                disabledGetRandomCode = false;
                if (msg.code === 200 && msg.data.access_token) {
                    window.localStorage.token = msg.data.access_token
                    window.localStorage.refreshToken = msg.data.refresh_token
                    window.localStorage.tenant = msg.data.tenant
                    window.localStorage.expiresIn = Date.now() + msg.data.expires_in * 1000
                    return window.location.href = '//' + location.host
                } else {
                    return alert('请重试')
                }

            });
        }

        //点击  Enter  键  登陆
        document.onkeydown = function (e) {
            var e = window.event ? window.event : e;
            if (e.keyCode == 13) {
                login();
            }
        }

        function forgetPwd() {
            window.location.href = 'tpl/registPage/forgetPassword.html?_=' + Math.random();
        }

        function goRegistPage() {
            window.location.href = "tpl/registPage/regist.html?_=" + Math.random();
        }

        // $(function () {
        //     $.get(reqBeforStr + '/Login/getCustom.htm', function (res) {
        //         var info = res.data;
        //         if (info.currCompanyLogo) {
        //             $("#logo-img").attr('src', info.currCompanyLogo);
        //         } else {
        //             $("#logo-img").attr('src', 'loginPageImg/logo.png')
        //         }
        //         if (info.customFlag) { // 1：是订制了特定域名的公司；0：新能云
        //             // $("#company-name").html(info.currCompanyName);
        //             $("#company-name").remove();
        //             $("#system-name").addClass('bigCompanyName');
        //         } else {
        //             $("#company-name").html('新能云');
        //         }
        //         if (info.os_title) {
        //             $("#system-name").html(info.os_title);
        //         } else {
        //             $("#system-name").html('新能源智能运营管理平台');
        //         }
        //     });
        // });

    </script>

    <!-- 判断当前浏览器是否可以进入系统 -->
    <script>
        var support_css3 = (function () {
            var div = document.createElement('div'),
                vendors = 'Ms O Moz Webkit'.split(' '),
                len = vendors.length;

            return function (prop) {
                if (prop in div.style) return true;

                prop = prop.replace(/^[a-z]/, function (val) {
                    return val.toUpperCase();
                });

                while (len--) {
                    if (vendors[len] + prop in div.style) {
                        return true;
                    }
                }
                return false;
            };
        })();
        function IEVersion() {
            var userAgent = navigator.userAgent; //取得浏览器的userAgent字符串
            var isIE = userAgent.indexOf("compatible") > -1 && userAgent.indexOf("MSIE") > -1; //判断是否IE<11浏览器
            var isEdge = userAgent.indexOf("Edge") > -1 && !isIE; //判断是否IE的Edge浏览器
            var isIE11 = userAgent.indexOf('Trident') > -1 && userAgent.indexOf("rv:11.0") > -1;
            if (isIE) {
                var reIE = new RegExp("MSIE (\\d+\\.\\d+);");
                reIE.test(userAgent);
                var fIEVersion = parseFloat(RegExp["$1"]);
                if (fIEVersion == 7) {
                    return 7;
                } else if (fIEVersion == 8) {
                    return 8;
                } else if (fIEVersion == 9) {
                    return 9;
                } else if (fIEVersion == 10) {
                    return 10;
                } else {
                    return 6;//IE版本<=7
                }
            } else if (isEdge) {
                return true;//edge
            } else if (isIE11) {
                return 11; //IE11
            } else {
                if (
                    support_css3('transform')
                    && support_css3('boxSizing')
                    && support_css3('flexWrap')
                ) return true;//不是ie浏览器
                return false;
            }
        }

        $('body').append('<div id="useCalc" style="width: calc(100% - 50px);-moz-calc(100% - 50px);-webkit-calc(100% - 50px);"></div>');
        if ($('#useCalc').width() === $('body').width()) disabledLogin();
        if (IEVersion() !== true) disabledLogin();
        if (!self.fetch) disabledLogin();
        function disabledLogin() {
            // $('#loginFormBlock').hide();
            $('body').append(
                '<div style="font-size:16px;background-color: rgba(0,0,0,.5);color:#fff;position:fixed;left:0;right:0;top:0;bottom:0;text-align:center;padding-top:250px;">' +
                '<div style="background: #fff url(./loginPageImg/noLogin.jpg) no-repeat;width:680px;height:350px;margin:0 auto;padding-top:50px;">' +
                '<span>您的浏览器版本太低，部分功能无法使用。</span>' +
                '<br/><br/>' +
                '<span>建议升级浏览器。</span><br/>' +
                '<br/><br/>' +
                '<a style="background: #29799e;border-radius:20px;display:inline-block;width:140px;color:#fff;line-height:40px;margin-right:2em;" target="_blank" href="https://www.google.cn/chrome/"><u>谷歌Chrome</u></a>' +
                '<a style="background: #29799e;border-radius:20px;display:inline-block;width:140px;color:#fff;line-height:40px;" target="_blank" href="http://www.firefox.com.cn/"><u>火狐浏览器</u></a><br/>' +
                '</div>' +
                '</div>'
            );
        }
    </script>
</body>

</html>
